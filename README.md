Path of exile 国服交易查询工具
======

本工具是《流放之路》（Path of exile）国服交易网站数据查询用的工具，使用Python编写，通过读取Excel配置文件按规则从[交易网站](https://poe.game.qq.com/trade/)爬取数据，并按规则输出

目录结构
------
```
Poe-trade-cn
├─ POE_Guugou.exe   # 执行文件
├─ config.ini       # 配置文件
├─ cache
│    └─ xxxx.json   # 请求时的缓存，短时间内重复请求时会直接加载缓存，可配置缓存时间
├─ filter
│    └─ xxxx.xlsx   # 过滤器“xxxx”的配置文件（文件名即过滤器名）
├─ run_xxxx.bat	    # 执行查询过滤器“xxxx”的批处理文件
└─ result_xxxx.xlsx # 执行run_xxxx.bat后生成的结果文件
```

使用流程
-------

1. 配置`config.ini`（主要是联盟选择要正确）
2. 配置过滤器文件（后续详述，也请多参考附带的示例文件，都是我自己使用的实际案例）
3. 执行`POE_Guugou.exe`，直接执行该文件会根据filter目录下的xlsx生成bat，每个xlsx生成一个bat
4. 执行`run_xxxx.bat`进行查询（注意不要同时执行多个查询，服务器有请求次数限制的机制）
5. 等待执行完成
6. 查看`result_xxxx.xlsx`

过滤器配置说明
------

由于是个人用，所以没有做过多的错误处理，建议复制例子进行修改，避免出错

过滤器配置文件共有2个工作薄，一个叫《抓取设置》一个叫《提取设置》

### 抓取设置

抓取设置页，设置需要抓取什么样搜索条件的物品

| 项目     | 类型   | 说明                                                    |
| -------- | ------ | ------------------------------------------------------- |
| 查询称呼 | 字符串 | 用于识别用的名称                                        |
| 代码     | 字符串 | 在官方交易网站输入搜索条件后点击搜索时生成的URL上的代码 |
| 模式     | 数字   | 有效值为0~2，请参考后面说明                             |
| 启用     | 字符串 | 是/否                                                   |
| 其他字段 |        | 无用，仅用作备注，读取时不会加载该内容                  |

#### 模式字段说明

模式共有三种

- 0：按照过滤器直接进行查询，搜索出的结果与官方网站上相同
- 1：“状态过滤中的第一组”中的每个项目，分别单独选中进行过滤，将结果汇总
- 2：“状态过滤中的第一组”中的项目，两两组合进行查询，将结果汇总

官方网站同一个查询条件，最多返回100个结果，所以当符合你条件的装备比较多时，可能比较难查询到全部结果，例如在结果量比较少的情况下，模式1和使用官方的“计数=1”模式结果其实是相同的，但在结果十分多的情况下，官方的“计数=1”只能查询到100个结果，模式1大概能查询到200~300个结果（排重后）

模式1和模式2只针对状态过滤的第一组（默认那组）进行拆分，所以如果有必选属性，可以添加第二组过滤来进行搜索

### 提取设置

提取设置页，可以配置需要提取的属性，通过正则表达式匹配，可以将特定属性提取出来进行统计，展示到结果的Excel文件中方便筛选

| 项目       | 类型   | 说明                                            |
| ---------- | ------ | ----------------------------------------------- |
| 属性       | 字符串 | 提取后计入的属性名称                            |
| 模式       | 数字   | 有效值为0~3，请参考后面的说明                   |
| 正则表达式 | 字符串 | 用于匹配的正则表达式，建议从编年史抄词缀属性    |
| 列表       | 字符串 | 用于模式2和模式3，多个值之间使用半角逗号“,”分隔 |
| 其他字段   |        | 无用，仅用作备注，读取时不会加载该内容          |

#### 属性字段说明

提取设置中，每一行是一个正则表达式，脚本会把装备属性的每一行与提取设置的每一行依次匹配，匹配成功就会按规则提取数据。装备属性的每一行可以命中多个正则表达式，提取多次，例如你可以将“所有元素抗性”写三行，分别计入火抗、冰抗和电抗

通过提取设置，可以将等效属性归总，以便筛选时排序，例如你使用双持武器+纯火系法术技能，“法术伤害”、“火焰法术伤害”、“火焰伤害”和“双持时法术伤害”等效果都是等效的，通过提取汇总，就可以轻松的找到作为“法术伤害”类型属性提升你伤害的词缀最好的那件

#### 模式字段说明

模式共有四种

- 0：累加模式，提取值必须为数字。每匹配成功一次，就将提取到的数字累加到属性上
- 1：覆盖模式，每匹配成功一次，就将提取到的内容覆盖到属性上，后提取到的会覆盖掉前面提取到的。这个模式以前用来提取星团珠宝天赋名称，后来由下面的模式2和3替代
- 2：计数模式（列表字段为黑名单），匹配成功后提取的匹配值会与列表进行对比，不在列表中的会进行计数
- 3：计数模式（列表字段为白名单），匹配成功后提取的匹配值会与列表进行对比，在列表中的会进行计数

模式2和模式3主要用于查找星团珠宝的天赋，如果你只有几个不想要的天赋，可以用模式2，并把不想要的列在列表。如果你只有几个想要的天赋，则可以用模式3，把想要的列在列表。列表中的字段注意使用半角逗号分隔

#### 正则表达式字段说明

正则表达式方面，如果你不熟悉Python的正则表达式，可以参考以下规则：

- 行首写`^`，行尾写`$`，这是正则里表示行首和行尾的标记，不添加此标记的话，会导致如`伤害提高 #%`能命中`近战伤害提高 #%`这样的词缀
- 要提取的数字写为`(\d+)`
  - `\d`表示数字，`+`表示1个或更多个数字，括号表示提取
  - 注意数字不包括小数点和百分号，所以如物理伤害吸蓝吸血，可以写成`0.(\d+)%`，只提取小数部分
  - 注意每行只能加1组括号，因为脚本只对每行提取了第一个值
  - `附加 # - # 基础物理伤害`这样的词缀，如果最小和最大值都需要的话，需要写2行提取规则，把2个数值分别提取出来
- 需要提取的非数字（主要是星团珠宝的天赋名称），写为`(.+?)`

